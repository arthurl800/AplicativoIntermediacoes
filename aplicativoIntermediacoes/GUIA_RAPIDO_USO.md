# üéØ Guia R√°pido - Sistema de Negocia√ß√µes

## ‚úÖ O Sistema Agora Funciona Completamente!

Todas as etapas do fluxo foram implementadas e testadas:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PASSO 1: Importar Planilha (CSV/XLSX)                       ‚îÇ
‚îÇ ‚Üí Dados entram em INTERMEDIACOES_TABLE                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ PASSO 2: Visualizar Painel de Negocia√ß√µes                   ‚îÇ
‚îÇ ‚Üí Mostra t√≠tulos dispon√≠veis (Quantidade > 0)              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ PASSO 3: Selecionar T√≠tulo e Clicar em "Negociar"          ‚îÇ
‚îÇ ‚Üí Abre formul√°rio com dados pr√©-preenchidos                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ PASSO 4: Preencher Dados da Negocia√ß√£o                      ‚îÇ
‚îÇ ‚Üí Vendedor: Taxa Sa√≠da, Valor Bruto/L√≠quido               ‚îÇ
‚îÇ ‚Üí Comprador: Taxa Entrada, Valor de Entrada               ‚îÇ
‚îÇ ‚Üí Assessor: Valor da Plataforma (comiss√£o)                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ PASSO 5: Processar Negocia√ß√£o (Server-Side)                ‚îÇ
‚îÇ ‚úì Calcula Pre√ßos Unit√°rios                                  ‚îÇ
‚îÇ ‚úì Calcula Ganhos e Rentabilidades                           ‚îÇ
‚îÇ ‚úì Calcula Corretagem e ROA                                  ‚îÇ
‚îÇ ‚úì Salva em NEGOCIACOES (detalhe completo)                   ‚îÇ
‚îÇ ‚úì Decrementa Quantidade em INTERMEDIACOES_TABLE            ‚îÇ
‚îÇ ‚úì Transfere para INTERMEDIACOES_TABLE_NEGOCIADA            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìç Acessos da Aplica√ß√£o

### **Upload**
```
http://localhost:8000/?controller=upload&action=index
```
- Selecione arquivo CSV ou XLSX com dados de intermedia√ß√µes
- Clique "Importar" ‚Üí insere em INTERMEDIACOES_TABLE

### **Painel de Negocia√ß√µes**
```
http://localhost:8000/?controller=negociacao&action=painel
```
- Lista t√≠tulos dispon√≠veis (Quantidade > 0)
- Clique em "Negociar" para abrir formul√°rio de venda

### **Intermedia√ß√µes Negociadas**
```
http://localhost:8000/?controller=dados&action=visualizar_negociadas
```
- Hist√≥rico de negocia√ß√µes (p√≥s-venda)
- Mostra volume, valores e datas

---

## üí° Campos da Negocia√ß√£o

### **Vendedor (Sa√≠da)**
| Campo | Entrada | C√°lculo |
|-------|---------|---------|
| Taxa de Sa√≠da (%) | ‚úèÔ∏è Voc√™ informa | - |
| Valor Bruto de Sa√≠da | ‚úèÔ∏è Ou autom√°tico | Unit√°rio √ó Quantidade |
| Valor L√≠quido de Sa√≠da | ‚úèÔ∏è Ou autom√°tico | Bruto √ó (1 - Taxa%) |
| **Pre√ßo Unit√°rio** | üìä C√°lculo | L√≠quido √∑ Quantidade |
| **Ganho** | üìä C√°lculo | L√≠quido - Custo Importado |
| **Rentabilidade (%)** | üìä C√°lculo | (Ganho √∑ Custo) √ó 100 |

### **Comprador (Entrada)**
| Campo | Entrada | C√°lculo |
|-------|---------|---------|
| Taxa de Entrada (%) | ‚úèÔ∏è Voc√™ informa | - |
| Valor de Entrada | ‚úèÔ∏è Voc√™ informa | - |
| **Pre√ßo Unit√°rio** | üìä C√°lculo | Valor √∑ Quantidade |

### **Assessor/Plataforma**
| Campo | Entrada | C√°lculo |
|-------|---------|---------|
| Valor da Plataforma | ‚úèÔ∏è Voc√™ informa | (comiss√£o) |
| **Corretagem** | üìä C√°lculo | = Valor Plataforma |
| **ROA (%)** | üìä C√°lculo | (Corretagem √∑ Valor Entrada) √ó 100 |

---

## üß™ Teste R√°pido da Funcionalidade

```bash
# 1. Verificar estado do banco
cd /var/www/html/aplicativoIntermediacoes
php scripts/check_db.php

# 2. Rodar teste integrado completo
php tests/test_negotiation_flow.php
```

**Esperado:**
```
‚úì NEGOCIACOES row inserted
‚úì INTERMEDIACOES_TABLE quantity updated correctly
‚úì INTERMEDIACOES_TABLE_NEGOCIADA rows inserted
‚úÖ TEST COMPLETED SUCCESSFULLY
```

---

## üîç Verifica√ß√µes no Banco

### INTERMEDIACOES_TABLE (Fonte)
```sql
-- T√≠tulos dispon√≠veis
SELECT id, Conta, Nome, Ativo, Quantidade 
FROM INTERMEDIACOES_TABLE 
WHERE Quantidade > 0;
```

### NEGOCIACOES (Log Completo)
```sql
-- Detalhe de cada negocia√ß√£o
SELECT id, Data_Registro, Conta_Vendedor, Quantidade_negociada,
       Valor_Liquido_Saida, Ganho_Saida, Rentabilidade_Saida
FROM NEGOCIACOES
ORDER BY Data_Registro DESC;
```

### INTERMEDIACOES_TABLE_NEGOCIADA (Hist√≥rico)
```sql
-- T√≠tulos negociados (volume vendido)
SELECT id, Conta, Nome, Ativo, Quantidade, Valor_Bruto
FROM INTERMEDIACOES_TABLE_NEGOCIADA
ORDER BY Data_Importacao DESC;
```

---

## ‚öôÔ∏è Configura√ß√µes

Arquivo: `/var/www/html/aplicativoIntermediacoes/config/database.php`

```php
return [
    'DB_HOST'     => 'localhost',
    'DB_NAME'     => 'INTERMEDIACOES',
    'DB_USER'     => 'INTERMEDIACOES_USER',
    'DB_PASS'     => '%intermediacoes999$#',
    'DB_CHARSET'  => 'utf8mb4',
    'TABLE_NAME'  => 'INTERMEDIACOES_TABLE',   // Fonte
    'USER_TABLE'  => 'USUARIOS_TABLE'          // Usu√°rios
];
```

---

## üöÄ Iniciando o Servidor (Desenvolvimento)

```bash
cd /var/www/html/aplicativoIntermediacoes

# Iniciar servidor PHP local
php -S localhost:8000 -t .

# Em outro terminal, testar
curl http://localhost:8000/?controller=negociacao&action=painel
```

---

## üìã Checklist Final

- [x] Upload/Importa√ß√£o CSV/XLSX ‚Üí INTERMEDIACOES_TABLE
- [x] Painel de Negocia√ß√µes mostra t√≠tulos dispon√≠veis
- [x] Formul√°rio pr√©-preenchido com dados
- [x] C√°lculos autom√°ticos server-side (seguran√ßa)
- [x] Persiste em NEGOCIACOES
- [x] Atualiza Quantidade em INTERMEDIACOES_TABLE
- [x] Transfere para INTERMEDIACOES_TABLE_NEGOCIADA
- [x] Teste integrado validando fluxo completo
- [ ] Dashboard com gr√°ficos (opcional)
- [ ] Auditoria/Log de usu√°rio (opcional)

---

## üìû Suporte R√°pido

### Erro: "Quantidade n√£o pode ser maior que dispon√≠vel"
‚Üí Verifique se h√° registros com Quantidade > 0 em INTERMEDIACOES_TABLE

### Erro: "Negocia√ß√£o n√£o encontrada"
‚Üí Certifique-se de que o ID passado existe e tem Quantidade > 0

### INTERMEDIACOES_TABLE_NEGOCIADA vazia
‚Üí Verifique se transfer foi chamado com `source_id` correto (implementado em NegociacaoController)

### Valores incorretos nos c√°lculos
‚Üí Todos os valores s√£o recalculados server-side. Verifique logs:
```bash
tail -f /var/log/php-errors.log
```

---

**Status:** ‚úÖ Sistema Operacional  
**√öltima atualiza√ß√£o:** 10 de dezembro de 2025  
**Vers√£o:** 1.0 - Fluxo Completo
